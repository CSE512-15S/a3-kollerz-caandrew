<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">

        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/style.css">
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://d3js.org/queue.v1.min.js"></script>
        <script src="http://d3js.org/topojson.v1.min.js"></script>
    </head>
    <body>

        <div class="container">
            <div id="main" class="row">
                <div id="svgContainer" class="col-xs-8">
                	<div id="controls">
                        <h2 class="title">Senatorial stances on Hillary for President</h2>
                        <form class="form-horizontal">
                        <fieldset>

                        <div class="form-group">
                            <label for="billAffiliate">In Senate under Bill?</label>
                            <div class="checkbox">
                                <label for="bill-yes"><input type="checkbox" name="billAffiliate" id="bill-yes" value="">Yes</label>
                            </div>
                            <div class="checkbox">
                                <label for="bill-no"><input type="checkbox" name="billAffiliate" id="bill-no" value="">No</label>
                            </div>
                        </div>

                        <!-- Checkboxes -->
                        <div class="form-group">
                    		<label for="gender">Gender</label>
                      		<div class="checkbox">
                      			<label for="gender-female"><input type="checkbox" name="gender" id="gender-female" value="">Female</label>
                     		</div>
                            <div class="checkbox">
                                <label for="gender-male"><input type="checkbox" name="gender" id="gender-male" value="">Male</label>
                            </div>                                
                        </div>

                        </fieldset>
                        </form>
                    </div>

                </div>
                <div id="detailView" class="col-xs-4">
                    <div id="map"></div>

                    <div id="info">

                        <svg id="senatorPortrait"></svg>
                        <p>
                            <h3 id="senatorName"></h3>
                            <span id="senatorState"></span>
                        </p>
                        <p>
                            <span></span>
                        </p>

                    </div>
                </div>
            </div>
        </div>

        <script>
			
        	// Parameters
            //------------------------------------------------------------------------
        	var margin = {top: 20, right: 10, bottom: 20, left: 30},
        		width = 760 - margin.left - margin.right,
        		height = 700 - margin.top - margin.bottom,
        		center = { x: 440, 
        				   y: 275 },
        		radius = { maximum: 350, rings: [150, 190, 230] },
                arcWidth = 0.2,
                arcMargin = 40,
        		rBigNode = 50,
        		rSmallNode = 10,
        		rImage = rBigNode * 0.75,
                originNonEndorsing = { x: 0, y: 500 },
                dimensionsNonEndorsing = { width: width, height: 140},
                nRows = 4,     // Number of rows
                nCols = 20;    // Number of nodes in a row

        	var imgURL_Hillary = "img/hillary.jpg";

        	// SVG Elements & other layout
            //------------------------------------------------------------------------
			var svg = d3.select("#svgContainer").append("svg")
			    .attr("width", width + margin.left + margin.right)
			    .attr("height", height + margin.top + margin.bottom)
			  .append("g")
			    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var nonEndorsingNodes = svg.append("g").attr("class", "grid")
                .attr("transform", "translate(" + originNonEndorsing.x + "," + originNonEndorsing.y + ")");

            // Little senator portrait
            var portraitWidth = rBigNode + 1;
            var senatorHead = d3.select("#senatorPortrait").append("g")
                .attr("class", "head")
                .attr("transform", "translate(" + portraitWidth + "," + portraitWidth + ")");

            senatorHead.append("circle")
                .attr("class", "outer")
                .attr("r", rBigNode);

            var senatorPortrait = senatorHead.append("circle")
                .attr("class", "inner")
                .attr("r", rImage);

            var defsMain = svg.append("defs");
            var defsSenatorPortrait = d3.select("#senatorPortrait").append("defs");

        	// Hillary Node
            //------------------------------------------------------------------------
        	var hillary = svg.append("g")
        		.attr("class", "hillary")
        		.attr("transform", "translate(" + center.x + "," + center.y + ")");

        	var endorsingNodes = hillary.append("g")
        		.attr("class", "rays");

        	var hillaryOuterCircle = hillary.append("circle")
        		.attr("class", "outer")
        		.attr("r", rBigNode);

        	var hillaryInnerCircle = hillary.append("circle")
        		.attr("class", "inner")
        	  	.attr("r", rImage);

        	addPortraitImage(defsMain, "portrait_Hillary", imgURL_Hillary);
            hillaryInnerCircle.style("fill", "url(#portrait_Hillary)");

        	// Load senator data
            //------------------------------------------------------------------------
            var senators;
        	d3.json("senators.json", function(err,data) {
        		if (err) {
        			alert("Error: Could not load data.");
        		}
        		senators = data.senators;

                // sort senators by reelection year
                senators.sort(function(a,b) {
                    return a.reElectionYear - b.reElectionYear;
                });

        		// The initial display
        		update(senators, false);
                //drawArcs(senators.filter(function(d) { return d.isEndorsing }));
        	});

            // Map
            //------------------------------------------------------------------------
			d3.xml("img/us.svg", "image/svg+xml", function(xml) {
			  document.getElementById("map").appendChild(xml.documentElement);
			});

            // Checkbox stuff
            //------------------------------------------------------------------------
            d3.selectAll("input[type=checkbox]").on("change", function(d) {
                // Collect filters
                var filterFemale = document.getElementById("gender-female").checked;
                var filterMale = document.getElementById("gender-male").checked;
                var filterBillYes = document.getElementById("bill-yes").checked;
                var filterBillNo = document.getElementById("bill-no").checked;

                if (filterFemale && filterMale) { // Show both
                    filterFemale = false;
                    filterMale = false;
                }

                if (filterBillYes && filterBillNo) { // Show both
                    filterBillYes = false;
                    filterBillNo = false;
                }

                // Filter senators 
                var filtered = senators.filter(function(d) {
                    var show = true;
                    if (filterFemale) {
                        show = show & d.isFemale;
                    } 
                    if (filterMale) {
                        show = show & !d.isFemale;
                    } 
                    if (filterBillYes) {
                        show = show & d.isBillAffiliate;
                    }
                    if (filterBillNo) {
                        show = show & !d.isBillAffiliate;
                    }
                    return show;
                });

                // Update
                update(filtered, true);
            });

        	// Functions
        	//------------------------------------------------------------------------
        	function update(data, animate) {

                // Endorsing senators
                // ------------------
                updateEndorsing(data.filter(function(d) { return d.isEndorsing }), animate);

                // Non-endorsing senators
                // ----------------------
                updateNonEndorsing(data.filter(function(d) { return !d.isEndorsing }), animate);
        	}

            function updateEndorsing(data, animate) {
                var keys = data.map(function(d) { return d.id; });

                var rScale = d3.scale.ordinal()
                    .domain(keys)
                    .range(data.map(function(d) {
                        if (d.reElectionYear == 2017) {
                            return radius.rings[0];
                        } else if (d.reElectionYear == 2019) {
                            return radius.rings[1];
                        } else if (d.reElectionYear == 2021) {
                            return radius.rings[2];
                        } else {
                            console.log(d.reElectionYear);
                            return radius.maximum;
                        }
                     }));

                var angle = d3.scale.ordinal()
                    .domain(keys)
                    .rangeBands([0, 360]);

                // DATA JOIN
                var rays = endorsingNodes.selectAll(".ray")
                    .data(data, function(d) { return d.id; });

                // ENTER: Create new elements as needed and make them visible
                var enter = rays.enter().append("g")
                    .attr("class", "ray");
                enter.append("line") // Creates line from hillary to circle
                    .attr("x1", rBigNode)
                    .attr("x2", function(d) { return rScale(d.id) });
                
                // arrange rays circularly
                enter.attr("transform", function(d) { return "rotate(" + -angle(d.id) + ")"; });
                
                // Show senator detail on mouseover
                enter.each(function (d,i) {
                    d3.select(this).on("mouseenter", function() { 
                        d3.select("#senatorName").html(d.name);
                        d3.select("#senatorState").html(d.state); 
                        d3.select("#" + d.stateAbbreviation).style("fill", "#aaa"); 
                        senatorPortrait.style("fill", "url(#portrait_" + d.id + ")");              
                        // TO DO 
                        //
                        // add more details
                        // change fill url to url(#portrait_id);
                     });
                     d3.select(this).on("mouseleave", function() { // Mouse leave. Reset details.
                        d3.select("#senatorName").html("");
                        d3.select("#senatorState").html(""); 
                        d3.select("#" + d.stateAbbreviation).style("fill", "#E0E0E0");
                        senatorPortrait.style("fill", "rgba(0,0,0,0)");               
                     });
                });

                var senatorCircles = enter.append("g") // Add containers for individual senators
                    .attr("class", function(d, i) { return "senator " + d.party; } )
                    .attr("transform", function(d, i) { return "translate(" + rScale(d.id) + ",0)"} );
            
                senatorCircles.append("circle") // Extends hover area
                    .attr("class", "hoverarea")
                    .attr("r", 20);

                senatorCircles.append("circle") // Add outer circles for individual senators
                    .attr("r", rSmallNode);

                senatorCircles.each(function(d,i) {
                    // Add Picture for senator
                    addPortraitImage(defsSenatorPortrait, "portrait_" + d.id, "img/senator" + d.id + ".png");
                });

                //UPDATE: Set current elements to visible
                rays.transition().duration(animate?500:0).style("opacity", 1.0);

                // EXIT: Set opactity to low for elements that are in exit set
                rays.exit().transition().duration(animate?500:0).style("opacity", 0.2);

            }

            function updateNonEndorsing(data, animate) {
                keys = data.map(function(d) { return d.id; });

                var xScale = d3.scale.ordinal()
                    .domain(keys)
                    .range(keys.map(function(d,i) {
                        var col = i % nCols;
                        return col * dimensionsNonEndorsing.width / nCols;
                    }));

                var yScale = d3.scale.ordinal()
                    .domain(keys)
                    .range(keys.map(function(d,i) { 
                        var row = Math.floor(i / nCols);
                        return dimensionsNonEndorsing.height - row * dimensionsNonEndorsing.height / nRows;
                    }));

                // DATA JOIN
                var areas = nonEndorsingNodes.selectAll(".area")
                    .data(data, function(d) { return d.id; });

                // ENTER: Create new elements as needed and make them visible
                var enter = areas.enter().append("g")
                    .attr("class", "area");

                // Arrange areas linearly
                enter.attr("transform", function(d) { return "translate(" + xScale(d.id) + ", " + yScale(d.id) + " )"; });

                // Show senator detail on mouseover
                enter.each(function (d,i) {
                    d3.select(this).on("mouseenter", function() { 
                        d3.select("#senatorName").html(d.name);
                        d3.select("#senatorState").html(d.state); 
                        d3.select("#" + d.stateAbbreviation).style("fill", "#aaa");
                        senatorPortrait.style("fill", "url(#portrait_" + d.id + ")");              
                        // TO DO 
                        //
                        // add more details
                        // change fill url to url(#portrait_id);
                     });
                     d3.select(this).on("mouseleave", function() { // Mouse leave. Reset details.
                        d3.select("#senatorName").html("");
                        d3.select("#senatorState").html(""); 
                        d3.select("#" + d.stateAbbreviation).style("fill", "#E0E0E0");  
                        senatorPortrait.style("fill", "rgba(0,0,0,0)");                           
                     });
                });

                // Add container & circles
                var senatorCircles = enter.append("g")
                    .attr("class", function(d, i) { return "senator " + d.party; } );
                senatorCircles.append("circle") // Extends hover area
                    .attr("class", "hoverarea")
                    .attr("r", 20);
                senatorCircles.append("circle")
                    .attr("r", rSmallNode);

                senatorCircles.each(function(d,i) {
                    // Add Picture for senator
                    addPortraitImage(defsSenatorPortrait, "portrait_" + d.id, "img/senator" + d.id + ".png");
                });

                //UPDATE: Set current elements to visible
                areas.transition().duration(animate?500:0).style("opacity", 1.0);

                // EXIT: Set opactity to low for elements that are in exit set
                areas.exit().transition().duration(animate?500:0).style("opacity", 0.2);
            }

        	// adds image from url to circle as pattern to defs. Id is unique identifier connecting the image
        	function addPortraitImage(defs, id, url) {
	        	defs.append("pattern")
	        		.attr("id", id)
	        		.attr("x", -1.1 *rImage)
	        		.attr("y", -1.1 * rImage)
	        	  	.attr("height", 2.2*rImage)
	        		.attr("width", 2.2*rImage)
	        		.attr("patternUnits", "userSpaceOnUse")
	        	  .append("image")
	        	  	.attr("x", 0)
	        	  	.attr("y", 0)
	        	  	.attr("height", 2.2*rImage)
	        		.attr("width", 2.2*rImage)
	        	  	.attr("xlink:href", url);
        	}

            function drawArcs(data) {
                var N = data.length;
                var years = [ 2017, 2019, 2021 ];
                var startAngle = 1.63;
                years.forEach(function(year, i) {
                    // Get number of senators with this reelection year
                    var n = data.filter(function(d) { return d.reElectionYear == year } ).length;
                    var endAngle = startAngle - 2 * Math.PI * (n - 0.6) / N;
                    console.log(endAngle);
                    var innerRadius = radius.rings[i] + arcMargin;
                    var arc = d3.svg.arc()
                        .innerRadius(innerRadius)
                        .outerRadius(innerRadius + arcWidth)
                        .startAngle(startAngle)
                        .endAngle(endAngle);

                    hillary.append("path").attr("d", arc)
                        .attr("class", "arc");

                    startAngle = endAngle - 0.14;
                });
            }

		</script>

    </body>
</html>
